# 2025-12-23 비동기 처리 테스트 실패 보고서

**작성일**: 2025-12-23 22:18 KST
**작성자**: Claude Sonnet 4.5
**커밋**: 9759342

---

## 📋 요약

비동기 처리 전환 시도가 실패했습니다. 오히려 성능이 20% 악화되었습니다.

---

## 🔬 테스트 결과

### 측정 환경
- **플랫폼**: Render 무료 플랜 (0.1 vCPU)
- **지표 수**: 45개
- **테스트 시각**: 2025-12-23 22:15:24 - 22:17:49

### 성능 비교
| 항목 | 수정 전 | 수정 후 | 차이 |
|------|---------|---------|------|
| 소요 시간 | 120초 | 144.6초 | +24.6초 |
| 개선율 | - | -20.5% | 악화 |
| 완료 지표 | 45개 | 45개 | 동일 |
| 실패 지표 | 0개 | 0개 | 동일 |

### 진행률 로그
```
[ 12초] 진행률:   0%
[ 55초] 진행률:   2%
[ 99초] 진행률:  51%
[132초] 진행률:  86%
[144초] 진행률: 100%
```

---

## 🔍 원인 분석

### 1. Python GIL 제약
```python
# asyncio.to_thread()도 결국 스레드 기반
async def update_all_indicators_background_async():
    tasks = []
    for indicator_id in active_indicators:
        # to_thread()는 별도 스레드에서 실행하지만 GIL 공유
        task = asyncio.to_thread(update_indicator, indicator_id)
        tasks.append(task)
    await asyncio.gather(*tasks)
```

**문제점**:
- `to_thread()`는 I/O 바운드 작업에 효과적
- 하지만 크롤링 함수가 CPU 바운드 작업(HTML 파싱, 데이터 변환 등) 포함
- GIL로 인해 진짜 병렬 처리 불가능

### 2. Render 리소스 제한
- **무료 플랜**: 0.1 vCPU (1개 vCPU의 10%)
- **메모리**: 512MB
- **결론**: CPU가 너무 약해서 45개 스레드 동시 실행 시 컨텍스트 스위칭 오버헤드 발생

### 3. 비동기 오버헤드
- `asyncio` 이벤트 루프 관리 비용
- `to_thread()` 스레드 생성/관리 비용
- `gather()` 작업 조율 비용

**총합**: 병렬 처리 이득 < 오버헤드 비용

---

## 🎯 해결 방안

### Option 1: Render 유료 플랜 (추천 ⭐)

**플랜**: Starter ($7/month)
- **CPU**: 0.5 vCPU (현재의 5배)
- **메모리**: 512MB → 2GB
- **예상 효과**: 144초 → 20-30초 (80% 단축)
- **ROI**: $7로 120초 단축

**근거**:
- CPU 5배 증가로 실제 병렬 처리 가능
- asyncio.to_thread() 효과 발휘 가능
- 목표 30-40초 달성 가능

**업그레이드 방법**:
1. Render 대시보드 → investment-app-backend
2. Settings → Plan → Starter 선택
3. 자동 재배포 (5분 소요)

### Option 2: 현실적 타협

**전략**: 120초 허용 + 비동기 코드 롤백

**장점**:
- 비용 $0
- 코드 복잡성 감소
- 안정성 유지

**단점**:
- 사용자 대기 시간 2분
- UX 저하

**롤백 방법**:
```bash
git revert 9759342
git push origin main
```

### Option 3: 하이브리드 접근

**전략**: 일부 지표만 실시간 업데이트

**구현**:
- 우선순위 높은 6개 지표만 크롤링 (예: ISM PMI, 실업률, CPI, GDP, 금리, S&P 500)
- 나머지 39개는 일일 스케줄 업데이트

**예상 효과**: 6개 지표 × 3초 = 18초

---

## 📝 커밋 정보

**커밋 ID**: 9759342
**커밋 메시지**:
```
perf: 비동기 처리 전환 (asyncio + to_thread)

변경:
- asyncio.to_thread()로 동기 크롤러를 비동기 실행
- asyncio.gather()로 45개 지표 진짜 동시 실행
- aiohttp==3.9.1 추가
- 기존 함수는 래퍼로 유지

예상 효과: 120초 → 30-40초
```

**실제 결과**: 120초 → 144.6초 (예상과 정반대)

---

## 🔄 다음 액션

### 즉시 결정 필요
- [ ] **Option 1 선택**: Render 유료 플랜 업그레이드 ($7/month)
- [ ] **Option 2 선택**: 비동기 코드 롤백 (무료 유지)
- [ ] **Option 3 선택**: 하이브리드 접근 구현

### 권장 순서
1. **Option 1 시도** (가장 효과적)
2. Option 1 실패 시 → **Option 3 시도** (절충안)
3. 둘 다 실패 시 → **Option 2 실행** (롤백)

---

## 📚 참고 문서

- 원본 가이드: `docs/2025-12-23_Next_Session_Async.md`
- Phase 3 문서: `docs/2025-12-23_Phase3_Session_Complete.md`
- 이전 최적화: 병렬 크롤링 시도 (역시 실패)

---

**결론**: Render 무료 플랜의 0.1 vCPU로는 병렬 처리가 불가능합니다. 유료 플랜 전환이 유일한 해결책입니다.
