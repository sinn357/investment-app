name: Keep Render Service Alive

  on:
    schedule:
      # ë§¤ 28ë¶„ë§ˆë‹¤ ì‹¤í–‰ (ìŠ¬ë¦½ ì „ 2ë¶„ ì—¬ìœ )
      - cron: '*/28 * * * *'
    workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

  jobs:
    keep-alive:
      runs-on: ubuntu-latest
      steps:
        - name: Check KST Time
          id: time-check
          run: |
            CURRENT_HOUR_KST=$(TZ=Asia/Seoul date '+%H')
            echo "KST Hour: $CURRENT_HOUR_KST"

            # í™œì„± ì‹œê°„ëŒ€ ì²´í¬ (KST 10:00-04:00)
            if [[ $CURRENT_HOUR_KST -ge 10 || $CURRENT_HOUR_KST -lt 4 ]]; then
              echo "should_ping=true" >> $GITHUB_OUTPUT
            else
              echo "should_ping=false" >> $GITHUB_OUTPUT
            fi

        - name: Ping Render Service
          if: steps.time-check.outputs.should_ping == 'true'
          run: |
            echo "ğŸš€ Pinging Render service at $(TZ=Asia/Seoul date)"

            # í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://investment-app-backend-x166.onrender.com/api/health || echo "000")

            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… Ping successful - Status: $HTTP_STATUS"
            else
              echo "âŒ Ping failed - Status: $HTTP_STATUS"

              # ë£¨íŠ¸ ê²½ë¡œë„ ì‹œë„
              HTTP_STATUS_ROOT=$(curl -s -o /dev/null -w "%{http_code}" https://investment-app-backend-x166.onrender.com/ || echo "000")

              if [ "$HTTP_STATUS_ROOT" = "200" ]; then
                echo "âœ… Root path ping successful - Status: $HTTP_STATUS_ROOT"
              else
                echo "âŒ Both endpoints failed - API: $HTTP_STATUS, Root: $HTTP_STATUS_ROOT"
              fi

              # ì‹¤íŒ¨í•´ë„ workflowëŠ” ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬ (ì¼ì‹œì  ì˜¤ë¥˜ í—ˆìš©)
              exit 0
            fi

        - name: Skip Ping (Sleep Hours)
          if: steps.time-check.outputs.should_ping == 'false'
          run: |
            echo "ğŸ˜´ í˜„ì¬ ë¹„í™œì„± ì‹œê°„ëŒ€ (KST 04:00~10:00) - Ping ìŠ¤í‚µ"
            echo "ë‹¤ìŒ í™œì„± ì‹œê°„: ì˜¤ì „ 10:00 KST"
