name: Keep Render Service Alive

on:
  schedule:
    - cron: '*/25 * * * *'
  workflow_dispatch:

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    steps:
      - name: Check KST Time
        id: time-check
        run: |
          CURRENT_HOUR_KST=$(TZ=Asia/Seoul date '+%H')
          echo "KST Hour: $CURRENT_HOUR_KST"

          if [[ $CURRENT_HOUR_KST -ge 10 || $CURRENT_HOUR_KST -lt 4 ]]; then
            echo "should_ping=true" >> $GITHUB_OUTPUT
          else
            echo "should_ping=false" >> $GITHUB_OUTPUT
          fi

      - name: Ping Render Service
        if: steps.time-check.outputs.should_ping == 'true'
        run: |
          echo "ğŸš€ Pinging Render service at $(TZ=Asia/Seoul date)"

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://investment-app-backend-x166.onrender.com/api/health || echo "000")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Ping successful - Status: $HTTP_STATUS"
          else
            echo "âŒ Ping failed - Status: $HTTP_STATUS"

            HTTP_STATUS_ROOT=$(curl -s -o /dev/null -w "%{http_code}" https://investment-app-backend-x166.onrender.com/ || echo "000")

            if [ "$HTTP_STATUS_ROOT" = "200" ]; then
              echo "âœ… Root path ping successful - Status: $HTTP_STATUS_ROOT"
            else
              echo "âŒ Both endpoints failed - API: $HTTP_STATUS, Root: $HTTP_STATUS_ROOT"
            fi

            exit 0
          fi

      - name: Skip Ping (Sleep Hours)
        if: steps.time-check.outputs.should_ping == 'false'
        run: |
          echo "ğŸ˜´ í˜„ì¬ ë¹„í™œì„± ì‹œê°„ëŒ€ (KST 04:00~10:00) - Ping ìŠ¤í‚µ"
          echo "ë‹¤ìŒ í™œì„± ì‹œê°„: ì˜¤ì „ 10:00 KST"
